<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Auditoría Vial - Heatmap de Riesgos</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <style>
    body{
      background:#1e1e1e;
      color:#eee;
      font-family: system-ui;
      font-size:.85rem;
      padding:15px;
    }

    .panel{
      background:#2b2b2b;
      border:1px solid #444;
      border-radius:8px;
      padding:12px;
      margin-bottom:12px;
    }

    .form-control,.form-select{
      background:#333;
      color:#fff;
      border:1px solid #555;
      font-size:.8rem;
    }

    #map{ height:460px }
    #miniMap{ height:260px }

    .table-container{
      height:460px;
      overflow:auto;
      border:1px solid #444;
      border-radius:6px;
    }

    .zone-text{color:#4fc3f7;font-weight:bold}
    .addr-text{color:#bbb}

    .badge-diag{font-size:.7rem;padding:3px 6px;border:1px solid;background:transparent}
    .risk{color:#ff5252;border-color:#ff5252}
    .habit{color:#e040fb;border-color:#e040fb}
    .temp{color:#40c4ff;border-color:#40c4ff}

    .btn-gps{
      font-size:.7rem;
      border:1px solid #666;
      background:transparent;
      color:#aaa;
    }

    .modal-content{
      background:#2b2b2b;
      color:#fff;
    }
  </style>
</head>

<body>

<div class="container-fluid p-0">

  <div class="panel">

    <div class="row g-2 align-items-end">

      <div class="col-md-3">
        <label class="form-label text-warning">Archivo Excel</label>
        <input type="file" id="uploadInput" class="form-control" accept=".xlsx,.xls"/>
        <small id="statusMsg" class="text-muted">Esperando archivo...</small>
      </div>

      <div class="col-md-2">
        <label>Desde</label>
        <input type="date" id="dateStart" class="form-control">
      </div>

      <div class="col-md-2">
        <label>Hasta</label>
        <input type="date" id="dateEnd" class="form-control">
      </div>

      <div class="col-md-2">
        <label>Diagnóstico</label>
        <select id="filterDiag" class="form-select">
          <option value="all">Todos</option>
          <option value="risk">Riesgo</option>
          <option value="habit">Hábito</option>
          <option value="temp">Temporal</option>
        </select>
      </div>

      <div class="col-md-3 text-end">
        <span class="badge bg-secondary" id="eventCount">0 eventos</span>
      </div>

    </div>
  </div>

  <div class="row g-2">

    <div class="col-lg-5">
      <div class="panel p-0">
        <div id="map"></div>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="table-container">
        <table class="table table-dark table-sm">
          <thead>
            <tr>
              <th>Zona / Dirección</th>
              <th>Cant</th>
              <th>Placas</th>
              <th>Días</th>
              <th>Diagnóstico</th>
            </tr>
          </thead>
          <tbody id="tbodyAnalysis"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>


<!-- LIBS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<script>

let map, heatLayer;
let rawData=[];

const RADIUS=20;

initMap();

function initMap(){
  map=L.map('map').setView([-9,-75],5);

  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png')
  .addTo(map);
}


document.getElementById("uploadInput").addEventListener("change",handleFile);
["dateStart","dateEnd","filterDiag"].forEach(id=>{
  document.getElementById(id).addEventListener("change",runAnalysis)
});


function handleFile(e){
  const file=e.target.files[0];
  if(!file) return;

  const reader=new FileReader();

  reader.onload=(ev)=>{
    const wb=XLSX.read(ev.target.result,{type:"array"});
    const sheet=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(sheet,{header:1});

    rawData=[];

    rows.slice(1).forEach(r=>{
      if(!r[2]) return;

      rawData.push({
        lat:parseFloat(r[2]),
        lon:parseFloat(r[3]),
        date:r[0]
      });
    });

    document.getElementById("statusMsg").innerText=`${rawData.length} registros cargados`;
    runAnalysis();
  };

  reader.readAsArrayBuffer(file);
}


function runAnalysis(){

  if(!rawData.length) return;

  const pts=rawData.map(p=>[p.lat,p.lon,1]);

  if(heatLayer) map.removeLayer(heatLayer);

  heatLayer=L.heatLayer(pts,{
    radius:25,
    blur:15,
    minOpacity:.5
  }).addTo(map);

  map.fitBounds(pts.map(p=>[p[0],p[1]]));

  document.getElementById("eventCount").innerText=pts.length+" eventos";
}

</script>

</body>
</html>
